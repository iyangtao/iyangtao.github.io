

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/MyInfo/%E5%A4%B4%E5%83%8F.jpg">
  <link rel="icon" href="/img/MyInfo/%E5%A4%B4%E5%83%8F.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yangtao">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言在移动互联网与 IoT 场景下，“毫秒级、双向实时通信” 已成为业务标配：在线聊天、实时协作、行情推送、游戏对战……传统 HTTP 轮询或长轮询不仅延迟高，而且资源浪费严重。 WebSocket 自 2011 年纳入 RFC 6455，提供了浏览器原生支持的 全双工、持久化 通道，是解决上述痛点的行业通用方案。本文先从协议原理出发，梳理握手、帧格式、心跳机制等基础知识；随后给出 Java 8">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSocket实战">
<meta property="og:url" content="http://example.com/2025/05/11/websocket/index.html">
<meta property="og:site_name" content="Yangtao&#39;s space">
<meta property="og:description" content="前言在移动互联网与 IoT 场景下，“毫秒级、双向实时通信” 已成为业务标配：在线聊天、实时协作、行情推送、游戏对战……传统 HTTP 轮询或长轮询不仅延迟高，而且资源浪费严重。 WebSocket 自 2011 年纳入 RFC 6455，提供了浏览器原生支持的 全双工、持久化 通道，是解决上述痛点的行业通用方案。本文先从协议原理出发，梳理握手、帧格式、心跳机制等基础知识；随后给出 Java 8">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1304850123.cos.ap-guangzhou.myqcloud.com/websocket.png">
<meta property="article:published_time" content="2025-05-11T15:54:13.000Z">
<meta property="article:modified_time" content="2025-05-11T15:54:13.000Z">
<meta property="article:author" content="Yangtao">
<meta property="article:tag" content="WebSocket">
<meta property="article:tag" content="计算机网络">
<meta property="article:tag" content="网络协议">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog-1304850123.cos.ap-guangzhou.myqcloud.com/websocket.png">
  
  
  <title>WebSocket实战 - Yangtao&#39;s space</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Programmer Yangtao</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                作者
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://blog-1304850123.cos.ap-guangzhou.myqcloud.com/websocket.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="WebSocket实战">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Yangtao
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-05-11 23:54" pubdate>
        2025年5月11日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      15k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      25 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">WebSocket实战</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：1 个月前
                
              </p>
            
            <div class="markdown-body">
              <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在移动互联网与 IoT 场景下，“毫秒级、双向实时通信” 已成为业务标配：在线聊天、实时协作、行情推送、游戏对战……传统 HTTP 轮询或长轮询不仅延迟高，而且资源浪费严重。</p>
<p>WebSocket 自 2011 年纳入 RFC 6455，提供了浏览器原生支持的 <strong>全双工、持久化</strong> 通道，是解决上述痛点的行业通用方案。本文先从协议原理出发，梳理握手、帧格式、心跳机制等基础知识；随后给出 <strong>Java 8 原生实现</strong>，帮助读者快速上手；最后落地到 <strong>Spring Boot 2.7.18 + JWT + Redis</strong> 的生产级示例，展示如何在分布式环境下实现鉴权、点对点私聊与全局广播。读完本文，你将具备从 0 到 1 搭建企业级 WebSocket 服务的完整思路与代码骨架。</p>
<h2 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h2><h3 id="缘起与定位"><a href="#缘起与定位" class="headerlink" title="缘起与定位"></a>缘起与定位</h3><ul>
<li><strong>痛点</strong>：HTTP 天生是请求–响应模式，服务端无法主动推送，实时性差。</li>
<li><strong>方案</strong>：WebSocket（RFC 6455，2011 发布）在浏览器与服务器之间建立一条<strong>全双工</strong>、<strong>持久化</strong>的 TCP 连接，允许双方随时发送数据。</li>
</ul>
<h3 id="握手流程（HTTP-Upgrade）"><a href="#握手流程（HTTP-Upgrade）" class="headerlink" title="握手流程（HTTP Upgrade）"></a>握手流程（HTTP Upgrade）</h3><ol>
<li><p><strong>客户端发起 HTTP/1.1 请求</strong></p>
<figure class="highlight http"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/chat</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Sec-WebSocket-Key</span><span class="hljs-punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==<br><span class="hljs-attribute">Sec-WebSocket-Version</span><span class="hljs-punctuation">: </span>13<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>https://example.com          # 可选，防跨站<br><span class="hljs-attribute">Sec-WebSocket-Protocol</span><span class="hljs-punctuation">: </span>json, chat   # 可选，子协议<br></code></pre></div></td></tr></table></figure></li>
<li><p><strong>服务器返回 101 Switching Protocols</strong></p>
<figure class="highlight http"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">101</span> Switching Protocols<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Sec-WebSocket-Accept</span><span class="hljs-punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=<br><span class="hljs-attribute">Sec-WebSocket-Protocol</span><span class="hljs-punctuation">: </span>chat        # 若协商成功<br></code></pre></div></td></tr></table></figure>

<ul>
<li><code>Sec-WebSocket-Accept = BASE64(SHA-1(Sec-WebSocket-Key + GUID))</code></li>
<li>握手成功后，连接切换到 WebSocket 帧语义，结束所有 HTTP 语义。</li>
</ul>
</li>
</ol>
<h3 id="数据帧结构"><a href="#数据帧结构" class="headerlink" title="数据帧结构"></a>数据帧结构</h3><table>
<thead>
<tr>
<th>字段</th>
<th>长度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>FIN</td>
<td>1 bit</td>
<td>是否为消息最后一帧</td>
</tr>
<tr>
<td>RSV1-3</td>
<td>1 bit×3</td>
<td>扩展使用，正常为 0</td>
</tr>
<tr>
<td>Opcode</td>
<td>4 bit</td>
<td>0x1 文本，0x2 二进制，0x8 关闭，0x9 Ping，0xA Pong…</td>
</tr>
<tr>
<td>MASK</td>
<td>1 bit</td>
<td><strong>客户端→服务器必须为 1</strong>；服务器→客户端通常为 0</td>
</tr>
<tr>
<td>Payload Len</td>
<td>7/7+16/7+64 bit</td>
<td>0–125，126，127 长度指示</td>
</tr>
<tr>
<td>Masking-Key</td>
<td>0/32 bit</td>
<td>仅当 MASK=1 时存在</td>
</tr>
<tr>
<td>Payload Data</td>
<td>可变</td>
<td>真正的数据内容</td>
</tr>
</tbody></table>
<ul>
<li><strong>掩码（Masking）</strong>：浏览器必须对出站数据用随机 32 bit Key 异或；防止代理缓存与协议混淆攻击。</li>
<li><strong>分片</strong>：大消息可拆成多帧（FIN=0）。</li>
<li><strong>控制帧</strong>最大 125 bytes，必须独立（Ping/Pong/Close）。</li>
</ul>
<h3 id="连接保活与关闭"><a href="#连接保活与关闭" class="headerlink" title="连接保活与关闭"></a>连接保活与关闭</h3><table>
<thead>
<tr>
<th>场景</th>
<th>机制</th>
</tr>
</thead>
<tbody><tr>
<td>保活</td>
<td>任一端可 <strong>Ping→Pong</strong> 确认活跃；无强制间隔，常配合业务心跳定制</td>
</tr>
<tr>
<td>关闭</td>
<td>发送 Close 帧（Code+Reason），收到方应回复 Close 并断 TCP（半握手式关闭）</td>
</tr>
</tbody></table>
<p>常见关闭码：1000 正常；1001 终端离开；1006 保留给异常断线（仅本地可见）。</p>
<h3 id="子协议与扩展"><a href="#子协议与扩展" class="headerlink" title="子协议与扩展"></a>子协议与扩展</h3><ul>
<li><strong>子协议</strong> (<code>Sec-WebSocket-Protocol</code>)：同一连接内约定更高层语义，如 <code>graphql-ws</code>、<code>mqtt</code>、<code>jsonrpc</code>。</li>
<li><strong>扩展</strong> (<code>Sec-WebSocket-Extensions</code>)：帧级能力，如 <code>permessage-deflate</code> 压缩、分片重排扩展。需双方协商一致。</li>
</ul>
<h3 id="安全考量"><a href="#安全考量" class="headerlink" title="安全考量"></a>安全考量</h3><table>
<thead>
<tr>
<th>风险</th>
<th>对策</th>
</tr>
</thead>
<tbody><tr>
<td>明文窃听/篡改</td>
<td>使用 **wss://**（TLS）</td>
</tr>
<tr>
<td>跨站 WebSocket 劫持 (CSWSH)</td>
<td>校验 Origin / token / Cookie SameSite</td>
</tr>
<tr>
<td>反射型 DOS</td>
<td>服务器应限制 Ping / Payload 大小</td>
</tr>
<tr>
<td>代理缓存混淆</td>
<td>客户端强制 Mask，服务端验证 Upgrade 头完整性</td>
</tr>
</tbody></table>
<h3 id="与-HTTP-HTTP-2-Server-Sent-Events-对比"><a href="#与-HTTP-HTTP-2-Server-Sent-Events-对比" class="headerlink" title="与 HTTP/HTTP-2/Server-Sent Events 对比"></a>与 HTTP/HTTP-2/Server-Sent Events 对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>WebSocket</th>
<th>SSE</th>
<th>HTTP/2+push</th>
</tr>
</thead>
<tbody><tr>
<td>双向通信</td>
<td>√</td>
<td>×（服务端单向）</td>
<td>理论可推送，但浏览器已弃用</td>
</tr>
<tr>
<td>传输层</td>
<td>TCP（或 TLS）</td>
<td>同</td>
<td>同</td>
</tr>
<tr>
<td>报文开销</td>
<td>极低（帧头 2–14 字节）</td>
<td>较低</td>
<td>需 HTTP 头</td>
</tr>
<tr>
<td>代理兼容</td>
<td>需显式支持 Upgrade</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>典型场景</td>
<td>IM、实时协作、游戏</td>
<td>股票行情、日志流</td>
<td>资源预加载</td>
</tr>
</tbody></table>
<h3 id="优缺点与适用场景"><a href="#优缺点与适用场景" class="headerlink" title="优缺点与适用场景"></a>优缺点与适用场景</h3><p><strong>优点</strong></p>
<ul>
<li>真·全双工&amp;低延迟</li>
<li>单一持久连接降低握手开销</li>
<li>广泛浏览器支持（IE 10+）</li>
</ul>
<p><strong>局限</strong></p>
<ul>
<li>需专门服务器或网关（Nginx、Spring WebFlux、Socket.IO、Vert.x…）</li>
<li>中间件（反向代理、负载均衡、防火墙）须显式开启 Upgrade 支持</li>
<li>无自带断线重连与心跳，需要应用层实现</li>
</ul>
<p><strong>典型应用</strong>：在线聊天、实时协同编辑、行情推送、多人游戏、IoT 即时控制、直播弹幕、客服系统等。</p>
<h3 id="实现要点（后端）"><a href="#实现要点（后端）" class="headerlink" title="实现要点（后端）"></a>实现要点（后端）</h3><ol>
<li><strong>握手与协议栈</strong><ul>
<li>Java：<code>javax.websocket</code>、Spring Boot <code>WebSocketHandler</code></li>
<li>Node.js：<code>ws</code>、Socket.IO</li>
<li>Go：<code>gorilla/websocket</code></li>
</ul>
</li>
<li><strong>会话管理</strong>：连接分组、广播、点对点、身份校验。</li>
<li><strong>心跳&amp;重连策略</strong>：Ping/Pong + 客户端指数退避重连。</li>
<li><strong>流量治理</strong>：限连接数、限消息频率、防止大包。</li>
<li><strong>压缩</strong>：开启 <code>permessage-deflate</code> 时评估 CPU 开销。</li>
<li><strong>负载均衡</strong>：粘性会话或共享状态（如 Redis 发布订阅、消息队列）。</li>
</ol>
<h3 id="未来展望"><a href="#未来展望" class="headerlink" title="未来展望"></a>未来展望</h3><ul>
<li><strong>WebTransport / WebRTC DataChannel</strong>：更现代的多路复用、UDP 支持，可能在部分场景替代 WebSocket。</li>
<li>**HTTP/3 (QUIC)**：在 TLS + UDP 上的多路复用，将与 WebSocket (over HTTP/3) 协同进化。</li>
</ul>
<h2 id="Java-原生实现"><a href="#Java-原生实现" class="headerlink" title="Java 原生实现"></a>Java 原生实现</h2><p>在追求极简的场景（学习、PoC、微服务里自带 WebSocket 服务）下，我们可以抛开 Spring、Netty 等重量级框架，直接使用 Java EE 7 引入的 <code>javax.websocket</code> API。Java 8 自带该包（从 JDK 1.8u20 开始），配合轻量容器或 Tyrus Standalone，即可快速起 WebSocket 服务。</p>
<ol>
<li><p>环境准备</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>JDK</td>
<td>1.8 (UTF-8 编码)</td>
<td>原生 API</td>
</tr>
<tr>
<td>Maven</td>
<td>3.6+</td>
<td>打包 demo</td>
</tr>
<tr>
<td>运行方式 A</td>
<td><strong>Tomcat 8+ / Jetty 9+</strong></td>
<td>已内置 WebSocket 容器</td>
</tr>
<tr>
<td>运行方式 B</td>
<td><strong>Tyrus Standalone</strong></td>
<td>纯 Java SE 启动，最轻量</td>
</tr>
</tbody></table>
<p>下文同时给出容器部署与嵌入式启动两种方式。</p>
</li>
<li><p>Maven 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>space.yangtao<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-ws<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 仅在“嵌入式 Tyrus”时需要 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.glassfish.tyrus/tyrus-server --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.glassfish.tyrus<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tyrus-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 打可执行 JAR（嵌入式模式） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-shade-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>shade<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">transformers</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span></span><br><span class="hljs-tag">                                        <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span><br>                                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>space.yangtao.Bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                                <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">transformers</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></div></td></tr></table></figure>

<p>若选择 Tomcat 部署，可省略依赖，直接打 WAR。</p>
</li>
<li><p>服务端实现</p>
<p>EchoEndpoint（UTF-8）</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@ServerEndpoint(&quot;/echo&quot;)</span>   <span class="hljs-comment">// ws://host:port/echo</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoEndpoint</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicInteger ONLINE = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-meta">@OnOpen</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onOpen</span><span class="hljs-params">(Session session)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> cnt = ONLINE.incrementAndGet();<br>        System.out.println(<span class="hljs-string">&quot;WebSocket opened, sid=&quot;</span> + session.getId() + <span class="hljs-string">&quot;, online=&quot;</span> + cnt);<br>    &#125;<br><br>    <span class="hljs-meta">@OnMessage</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">onMessage</span><span class="hljs-params">(String msg, Session session)</span> </span>&#123;<br>        String reply = <span class="hljs-string">&quot;【&quot;</span> + LocalDateTime.now() + <span class="hljs-string">&quot;】echo: &quot;</span> + msg;<br>        System.out.println(<span class="hljs-string">&quot;sid=&quot;</span> + session.getId() + <span class="hljs-string">&quot; -&gt; &quot;</span> + msg);<br>        <span class="hljs-keyword">return</span> reply;        <span class="hljs-comment">// 直接返回 =&gt; 自动包装文本帧</span><br>    &#125;<br><br>    <span class="hljs-meta">@OnClose</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClose</span><span class="hljs-params">(Session session, CloseReason reason)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> cnt = ONLINE.decrementAndGet();<br>        System.out.println(<span class="hljs-string">&quot;WebSocket closed, sid=&quot;</span> + session.getId() +<br>                           <span class="hljs-string">&quot;, reason=&quot;</span> + reason.getReasonPhrase() + <span class="hljs-string">&quot;, online=&quot;</span> + cnt);<br>    &#125;<br><br>    <span class="hljs-meta">@OnError</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Session session, Throwable thr)</span> </span>&#123;<br>        System.err.println(<span class="hljs-string">&quot;sid=&quot;</span> + session.getId() + <span class="hljs-string">&quot; error: &quot;</span> + thr.getMessage());<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>Bootstrap（嵌入式 Tyrus 可选）</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bootstrap</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Server server = <span class="hljs-keyword">new</span> Server(<span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">null</span>, EchoEndpoint.class);<br>        <span class="hljs-keyword">try</span> &#123;<br>            server.start();<br>            System.out.println(<span class="hljs-string">&quot;WebSocket server started at ws://localhost:8080/echo&quot;</span>);<br>            <span class="hljs-comment">// 阻塞主线程</span><br>            Thread.currentThread().join();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            server.stop();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>若用 Tomcat/Jetty，只需把 EchoEndpoint 打包成 WAR 部署，容器会自动扫描 <code>@ServerEndpoint</code>。</p>
</li>
<li><p>运行与测试</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>步骤</th>
</tr>
</thead>
<tbody><tr>
<td><strong>容器</strong></td>
<td><code>mvn clean package -DskipTests</code> → 将 WAR 部署到 Tomcat <code>webapps/</code> → 浏览器连接 <code>ws://localhost:8080/&lt;context&gt;/echo</code></td>
</tr>
<tr>
<td><strong>嵌入式</strong></td>
<td><code>mvn clean package</code> → <code>java -jar target/websocket-echo-1.0-SNAPSHOT.jar</code> → 终端或浏览器连接 <code>ws://localhost:8080/echo</code></td>
</tr>
</tbody></table>
</li>
<li><p>常见问题 &amp; 小结</p>
<table>
<thead>
<tr>
<th>症状</th>
<th>排查要点</th>
</tr>
</thead>
<tbody><tr>
<td>404 / 500</td>
<td>容器未识别 <code>@ServerEndpoint</code>：确认 <code>javax.websocket-api</code> 冲突、<code>WEB-INF/web.xml</code> 无手动配置冲突</td>
</tr>
<tr>
<td>客户端握手失败</td>
<td>浏览器控制台看 <code>Request/Response</code>，是否返回 101；若是 WSS 需证书</td>
</tr>
<tr>
<td>多节点广播</td>
<td>WebSocket 连接有粘性，需借助 MQ / Redis 发布订阅做分发</td>
</tr>
<tr>
<td>心跳</td>
<td>建议业务层定时 <code>ping</code>/自定义消息，客户端断线重连</td>
</tr>
</tbody></table>
<p>至此，已经完成了一个纯原生 Java 8 WebSocket 的完整闭环：服务端、客户端、部署与测试。后续可基于此扩展身份校验、群聊、压缩、限流等生产级特性。</p>
</li>
</ol>
<h2 id="Spring-WebSocket"><a href="#Spring-WebSocket" class="headerlink" title="Spring WebSocket"></a>Spring WebSocket</h2><h3 id="链路"><a href="#链路" class="headerlink" title="链路"></a>链路</h3><p>使用 <strong>Spring-WebSocket</strong> 处理浏览器连接，同步集成 <strong>JWT 鉴权</strong> 与 <strong>Redis Pub/Sub</strong> 实现分布式广播。完整链路分三段：</p>
<table>
<thead>
<tr>
<th>阶段</th>
<th>关键动作</th>
</tr>
</thead>
<tbody><tr>
<td><strong>握手</strong></td>
<td>浏览器 <code>ws://…/ws?token=xxx</code> → <code>JwtHandshakeInterceptor</code> 校验 → 建立会话</td>
</tr>
<tr>
<td><strong>本机路由</strong></td>
<td><code>WsHandler</code> 收发消息；<code>WsSessionManager</code> 维护 <em>uid ↔ Session</em> 映射</td>
</tr>
<tr>
<td><strong>跨实例广播</strong></td>
<td><code>RedisPublisher</code> 将 <code>WsMessage</code> 发布到 <strong>Redis Channel</strong>；<code>RedisSubscriber</code> 订阅并分派给本机在线用户</td>
</tr>
</tbody></table>
<h3 id="核心类及职责"><a href="#核心类及职责" class="headerlink" title="核心类及职责"></a>核心类及职责</h3><table>
<thead>
<tr>
<th>类</th>
<th>作用</th>
<th>关键点</th>
</tr>
</thead>
<tbody><tr>
<td><code>JwtUtil</code></td>
<td>解析 / 校验 JWT</td>
<td><code>parseToken()</code> → 返回 userId</td>
</tr>
<tr>
<td><code>JwtHandshakeInterceptor</code></td>
<td>握手前拦截</td>
<td>从 URL 查询参数提取 <code>token</code> → 鉴权成功把 <code>uid</code> 放入 <code>attributes</code></td>
</tr>
<tr>
<td><code>WebSocketConfig</code></td>
<td>注册端点</td>
<td><code>registry.addHandler(wsHandler, &quot;/ws&quot;)</code> 并挂上拦截器</td>
</tr>
<tr>
<td><code>WsHandler</code></td>
<td>核心业务 Handler</td>
<td><code>afterConnectionEstablished()</code> 注册会话；<code>handleTextMessage()</code> 反序列化 <code>WsMessage</code> 并调用 <code>RedisPublisher</code></td>
</tr>
<tr>
<td><code>WsMessage</code></td>
<td>统一消息模型</td>
<td><code>uid</code>、<code>content</code>、<code>broadcast</code> 三字段</td>
</tr>
<tr>
<td><code>WsSessionManager</code></td>
<td>本机 Session 池</td>
<td><code>register / unregister / sendTo / broadcast</code></td>
</tr>
<tr>
<td><code>RedisPublisher</code></td>
<td>发布消息到 Redis</td>
<td><code>convertAndSend(&quot;ws-msg&quot;, json)</code></td>
</tr>
<tr>
<td><code>RedisSubscriber</code></td>
<td>订阅 <code>ws-msg</code> Channel</td>
<td>解析 <code>WsMessage</code> → 定向 / 广播 给本机 Session</td>
</tr>
<tr>
<td><code>RedisListenerConfig</code></td>
<td>官方写法订阅</td>
<td>用 <code>RedisMessageListenerContainer</code> 注册 <code>RedisSubscriber</code> (可选)</td>
</tr>
</tbody></table>
<p>生产环境还需 TLS、限流、心跳等配套，但与上表类职责正交。</p>
<h3 id="时序说明"><a href="#时序说明" class="headerlink" title="时序说明"></a>时序说明</h3><pre><code class=" mermaid">sequenceDiagram
    participant B as Browser
    participant G as Nginx / LB
    participant A as Pod-A
    participant R as Redis
    participant B2 as Pod-B

%% 握手阶段
    B-&gt;&gt;G: ws://example.com/ws?token=JWT
    G-&gt;&gt;A: ws (粘性连接)
    A-&gt;&gt;A: JwtHandshakeInterceptor\n解析 token → uid
    A--&gt;&gt;B: 101 Switching Protocols

%% 私聊消息
    B-&gt;&gt;A: &#123;&quot;uid&quot;:&quot;u2&quot;,&quot;content&quot;:&quot;hi&quot;,&quot;broadcast&quot;:false&#125;
    A-&gt;&gt;A: WsHandler 生成 WsMessage
    A-&gt;&gt;R: Redis PUBLISH ws-msg
    R--&gt;&gt;A: SUBSCRIBE\n(本机收到)
    R--&gt;&gt;B2: SUBSCRIBE\n(其他实例收到)
    A-&gt;&gt;A: WsSessionManager.sendTo(u2)
    B2-&gt;&gt;B2: WsSessionManager.sendTo(u2)

%% 广播消息
    Note over B: 若 broadcast=true\nRedisSubscriber 调用\nsessionManager.broadcast()
</code></pre>

<ol>
<li><strong>握手阶段</strong><ul>
<li>请求透过负载均衡到某节点；<code>JwtHandshakeInterceptor</code> 校验成功 → <code>uid</code> 存进 <code>WebSocketSession.attributes</code>。</li>
</ul>
</li>
<li><strong>会话注册</strong><ul>
<li><code>WsHandler.afterConnectionEstablished</code> 把 <code>(uid, session)</code> 注册到 **<code>WsSessionManager</code>**（可一人多端登录）。</li>
</ul>
</li>
<li><strong>消息入站</strong><ul>
<li>浏览器发送任意符合 <code>WsMessage</code> 结构的 JSON。</li>
<li><code>WsHandler.handleTextMessage</code> 反序列化后统一调用 <code>RedisPublisher.publish(msg)</code> ——<strong>所有消息先入 Redis</strong>，保证分布式一致。</li>
</ul>
</li>
<li><strong>跨实例分发</strong><ul>
<li>每个实例的 <code>RedisSubscriber</code> 订阅 <code>ws-msg</code>：<ul>
<li><code>broadcast=true</code> ⇒ <code>sessionManager.broadcast(json)</code>。</li>
<li>否则 <code>sessionManager.sendTo(msg.getUser(), json)</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>本机推送</strong><ul>
<li><code>WsSessionManager</code> 遍历目标 Session；<code>sendMessage()</code> 仅在 <code>isOpen()</code> 时发送，避免脏连接。</li>
</ul>
</li>
</ol>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><ol>
<li><p>新建 Spring Boot 项目，引入Maven依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Web &amp; WebSocket --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- JWT --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Redis (Lettuce 默认) --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li>
<li><p>添加 JWT 工具类（简化版）</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtUtil</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String secret;<br><br>    <span class="hljs-comment">// 解析并校验，成功返回 userId，失败抛异常</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">parseToken</span><span class="hljs-params">(String token)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Jwts.parser()<br>                   .setSigningKey(secret.getBytes(StandardCharsets.UTF_8))<br>                   .parseClaimsJws(token.replace(<span class="hljs-string">&quot;Bearer &quot;</span>, <span class="hljs-string">&quot;&quot;</span>))<br>                   .getBody()<br>                   .getSubject();   <span class="hljs-comment">// userId</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>定义握手拦截器，用于处理鉴权以及绑定会话</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtHandshakeInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandshakeInterceptor</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JwtUtil jwtUtil;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JwtHandshakeInterceptor</span><span class="hljs-params">(JwtUtil jwtUtil)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.jwtUtil = jwtUtil;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">beforeHandshake</span><span class="hljs-params">(ServerHttpRequest req,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   ServerHttpResponse resp,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   WebSocketHandler handler,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   Map&lt;String, Object&gt; attrs)</span> </span>&#123;<br>        URI uri = req.getURI();<br>        String query = uri.getQuery(); <span class="hljs-comment">// e.g. token=xxx.yyy.zzz</span><br>        <span class="hljs-keyword">if</span> (query != <span class="hljs-keyword">null</span> &amp;&amp; query.contains(<span class="hljs-string">&quot;token=&quot;</span>)) &#123;<br>            String token = Arrays.stream(query.split(<span class="hljs-string">&quot;&amp;&quot;</span>))<br>                    .filter(p -&gt; p.startsWith(<span class="hljs-string">&quot;token=&quot;</span>))<br>                    .map(p -&gt; p.substring(<span class="hljs-string">&quot;token=&quot;</span>.length()))<br>                    .findFirst().orElse(<span class="hljs-keyword">null</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 解析并校验，成功返回 userId，失败抛异常</span><br>                String userId = jwtUtil.parseToken(token);<br>                attrs.put(<span class="hljs-string">&quot;uid&quot;</span>, userId);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (JwtException e) &#123;<br>                resp.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHandshake</span><span class="hljs-params">(ServerHttpRequest r, ServerHttpResponse s,</span></span><br><span class="hljs-params"><span class="hljs-function">                                         WebSocketHandler h, Exception e)</span> </span>&#123; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>定义 WebSocket消息体</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WsMessage</span> </span>&#123;<br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 目标用户 </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String uid;<br>    <br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 文本内容 </span><br><span class="hljs-comment">     * */</span><br>    <span class="hljs-keyword">private</span> String content;<br>    <br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 是否广播标记；true 时忽略 user </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> broadcast;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>WebSocket 会话管理器</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WsSessionManager</span> </span>&#123;<br><br>    <span class="hljs-comment">// uid → 会话集合</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Set&lt;WebSocketSession&gt;&gt; pool = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(String uid, WebSocketSession s)</span> </span>&#123;<br>        pool.computeIfAbsent(uid, k -&gt; ConcurrentHashMap.newKeySet()).add(s);<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unregister</span><span class="hljs-params">(WebSocketSession s)</span> </span>&#123;<br>        pool.entrySet().removeIf(entry -&gt; entry.getValue().remove(s));<br>    &#125;<br><br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 精准投递 </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendTo</span><span class="hljs-params">(String uid, String json)</span> </span>&#123;<br>        pool.getOrDefault(uid, <span class="hljs-keyword">new</span> HashSet&lt;&gt;()).forEach(s -&gt; safeSend(s, json));<br>    &#125;<br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * 全局广播 </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">broadcast</span><span class="hljs-params">(String json)</span> </span>&#123;<br>        pool.values().stream().flatMap(Set::stream).forEach(s -&gt; safeSend(s, json));<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">safeSend</span><span class="hljs-params">(WebSocketSession s, String text)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (s.isOpen()) <span class="hljs-keyword">try</span> &#123; s.sendMessage(<span class="hljs-keyword">new</span> TextMessage(text)); &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>Redis发布/订阅组件</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisPublisher</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate template;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectMapper mapper;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publish</span><span class="hljs-params">(WsMessage msg)</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            template.convertAndSend(<span class="hljs-string">&quot;ws-msg&quot;</span>, mapper.writeValueAsString(msg));<br>        &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException ignored) &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisSubscriber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageListener</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WsSessionManager sessionManager;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectMapper mapper = <span class="hljs-keyword">new</span> ObjectMapper();<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        Objects.requireNonNull(stringRedisTemplate.getConnectionFactory()).getConnection()<br>                .subscribe(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;ws-msg&quot;</span>.getBytes());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message raw, <span class="hljs-keyword">byte</span>[] pattern)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            WsMessage msg = mapper.readValue(raw.getBody(), WsMessage.class);<br>            <span class="hljs-keyword">if</span> (msg.isBroadcast()) &#123;<br>                sessionManager.broadcast(msg.getContent());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                sessionManager.sendTo(msg.getUid(), msg.getContent());<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>WebSocket处理器</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WsHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TextWebSocketHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WsSessionManager sessionManager;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisPublisher publisher;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectMapper mapper = <span class="hljs-keyword">new</span> ObjectMapper();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession s)</span> </span>&#123;<br>        String uid = (String) s.getAttributes().get(<span class="hljs-string">&quot;uid&quot;</span>);<br>        sessionManager.register(uid, s);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleTextMessage</span><span class="hljs-params">(WebSocketSession s, TextMessage tm)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (tm.getPayload().equalsIgnoreCase(<span class="hljs-string">&quot;PING&quot;</span>)) &#123;<br>                s.sendMessage(<span class="hljs-keyword">new</span> TextMessage(<span class="hljs-string">&quot;PONG&quot;</span>));<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 客户端直接发送符合 WsMessage 结构的 JSON</span><br>            WsMessage msg = mapper.readValue(tm.getPayload(), WsMessage.class);<br><br>            <span class="hljs-comment">// 服务端可补充 from/时间戳等信息</span><br>            <span class="hljs-comment">// msg.setFrom(uid)...</span><br><br>            publisher.publish(msg);   <span class="hljs-comment">// 一律走 Redis，实现跨实例广播 / 定向</span><br>        &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterConnectionClosed</span><span class="hljs-params">(WebSocketSession s, CloseStatus cs)</span> </span>&#123;<br>        sessionManager.unregister(s);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-meta">spring.application.name</span>=<span class="hljs-string">spring-ws</span><br><br><span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">127.0.0.1</span><br><span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span><br><br><span class="hljs-meta">jwt.secret</span>=<span class="hljs-string">abc123</span><br></code></pre></div></td></tr></table></figure></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>协议层</strong>：一次 HTTP Upgrade 握手即可切换到轻量帧语义，帧头最小仅 2 Bytes，依靠 Ping/Pong 保活。</li>
<li><strong>开发层</strong>：Java 提供 <code>javax.websocket</code>（Tyrus）满足纯 JDK 场景；Spring-WebSocket 则无缝融入 MVC 生态，可配合拦截器完成 JWT 鉴权。</li>
<li><strong>分布式</strong>：使用 Redis Pub/Sub 解耦实例，实现 <strong>“写入一次，集群即达”</strong>；统一的 <code>WsMessage</code> 数据结构简化了本机与跨节点路由。</li>
<li><strong>生产层</strong>：心跳、限流、TLS、Origin 校验、日志监控缺一不可；推荐用 <code>RedisMessageListenerContainer</code>、Prometheus 指标与灰度发布完善运维链路。</li>
<li><strong>演进方向</strong>：随着 HTTP/3 与 WebTransport 普及，未来可在 QUIC/UDP 上获得更低延迟与多路复用能力，但短期内 WebSocket 仍是浏览器实时通信的主力军。</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/WebSocket/">WebSocket</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/WebSocket/">WebSocket</a>
                    
                      <a class="hover-with-bg" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
                    
                      <a class="hover-with-bg" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/14/es-first-acquaintance/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/02/17/javase-io-socket/">
                        <span class="hidden-mobile">Java IO——网络IO</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                  
                
                
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'iyangtao/iyangtao.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <span>power by: </span> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span><u>Hexo</u></span></a> <span> - </span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span><u>Fluid</u></span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>





  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize(null);
    }
  </script>




  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
